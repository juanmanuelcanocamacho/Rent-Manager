generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  passwordHash   String
  role           Role
  country        Country         @default(BOLIVIA)
  landlordId     String?         // For Managers: link to their Landlord
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @default(now()) @updatedAt
  tenantProfile  TenantProfile?  @relation("UserToTenantProfile")
  managedRooms   Room[]          @relation("LandlordRooms")
  managedTenants TenantProfile[] @relation("LandlordTenants")
  managedLeases  Lease[]         @relation("LandlordLeases")
  managedExpenses Expense[]       @relation("LandlordExpenses")
  
  // Relations for Manager-Landlord link
  owner          User?           @relation("LandlordToManagers", fields: [landlordId], references: [id])
  members        User[]          @relation("LandlordToManagers")
}

model TenantProfile {
  id                String    @id @default(cuid())
  userId            String    @unique
  landlordId        String
  fullName          String
  documentNumber    String?
  phoneE164         String?
  whatsappOptIn     Boolean   @default(false)
  generatedPassword String?
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt
  leases            Lease[]
  messages          Message[]
  user              User      @relation("UserToTenantProfile", fields: [userId], references: [id], onDelete: Cascade)
  landlord          User      @relation("LandlordTenants", fields: [landlordId], references: [id])

  @@unique([id, landlordId])
}

model Room {
  id         String     @id @default(cuid())
  name       String
  landlordId String
  status     RoomStatus @default(AVAILABLE)
  notes      String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @default(now()) @updatedAt
  expenses   Expense[]
  leases     Lease[]    @relation("LeaseToRoom")
  landlord   User       @relation("LandlordRooms", fields: [landlordId], references: [id])

  @@unique([id, landlordId])
}

model Lease {
  id              String            @id @default(cuid())
  tenantId        String
  landlordId      String
  startDate       DateTime
  endDate         DateTime?
  rentAmountCents Int
  billingDay      Int
  status          LeaseStatus       @default(ACTIVE)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @default(now()) @updatedAt
  invoices        Invoice[]
  tenant          TenantProfile     @relation(fields: [tenantId], references: [id])
  messages        Message[]
  notifications   NotificationLog[]
  rooms           Room[]            @relation("LeaseToRoom")
  landlord        User              @relation("LandlordLeases", fields: [landlordId], references: [id])

  @@unique([id, landlordId])
}

model Invoice {
  id            String            @id @default(cuid())
  leaseId       String
  dueDate       DateTime
  amountCents   Int
  status        InvoiceStatus     @default(PENDING)
  paidAt        DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now()) @updatedAt
  lease         Lease             @relation(fields: [leaseId], references: [id])
  notifications NotificationLog[]
  payment       Payment?
  proof         PaymentProof?
}

model Payment {
  id          String        @id @default(cuid())
  invoiceId   String        @unique
  paidDate    DateTime
  amountCents Int
  method      PaymentMethod
  note        String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @default(now()) @updatedAt
  invoice     Invoice       @relation(fields: [invoiceId], references: [id])
}

model PaymentProof {
  id        String        @id @default(cuid())
  invoiceId String        @unique
  method    PaymentMethod
  notes     String?
  createdAt DateTime      @default(now())
  invoice   Invoice       @relation(fields: [invoiceId], references: [id])
}

model Message {
  id         String        @id @default(cuid())
  leaseId    String
  tenantId   String
  content    String
  status     MessageStatus @default(OPEN)
  adminReply String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @default(now()) @updatedAt
  repliedAt  DateTime?
  lease      Lease         @relation(fields: [leaseId], references: [id])
  tenant     TenantProfile @relation(fields: [tenantId], references: [id])
}

model NotificationLog {
  id                String             @id @default(cuid())
  leaseId           String
  invoiceId         String?
  type              NotificationType
  toPhone           String
  payloadJson       Json
  sentAt            DateTime           @default(now())
  providerMessageId String?
  status            NotificationStatus @default(SENT)
  failed    String?
  sendDate          DateTime
  invoice           Invoice?           @relation(fields: [invoiceId], references: [id])
  lease             Lease              @relation(fields: [leaseId], references: [id])

  @@unique([invoiceId, type, sendDate])
  @@unique([leaseId, type, sendDate], name: "lease_type_date_unique")
}

model Expense {
  id          String          @id @default(cuid())
  landlordId  String
  description String
  amountCents Int
  date        DateTime        @default(now())
  category    ExpenseCategory
  roomId      String?
  room        Room?           @relation(fields: [roomId], references: [id])
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @default(now()) @updatedAt
  status      ExpenseStatus   @default(APPROVED)
  landlord    User            @relation("LandlordExpenses", fields: [landlordId], references: [id])

  @@unique([id, landlordId])
}

enum Role {
  LANDLORD
  TENANT
  MANAGER
}

enum Country {
  SPAIN
  BOLIVIA
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
}

enum LeaseStatus {
  ACTIVE
  ENDED
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  PAYMENT_PROCESSING
}

enum PaymentMethod {
  CASH
  BIZUM
  BANK
  OTHER
}

enum MessageStatus {
  OPEN
  CLOSED
}

enum NotificationType {
  REMINDER_3D
  DUE_TODAY
  OVERDUE_WEEKLY
}

enum NotificationStatus {
  SENT
  FAILED
}

enum ExpenseCategory {
  MAINTENANCE
  UTILITIES
  INSURANCE
  TAXES
  OTHER
}

enum ExpenseStatus {
  APPROVED
  PENDING
  REJECTED
}
